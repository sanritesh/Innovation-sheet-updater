image: python:3.9

definitions:
  services:
    docker:
      memory: 2048

pipelines:
  default:
    - step:
        name: Download and Process Booking Data
        services:
          - docker
        script:
          # Install Chrome and dependencies
          - apt-get update && apt-get install -y wget gnupg2
          - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
          - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list
          - apt-get update && apt-get install -y google-chrome-stable
          
          # Install Python dependencies
          - pip install -r requirements.txt
          
          # Create necessary directories
          - mkdir -p /tmp/BookingData_folder
          
          # Set up service account credentials from repository variable
          - echo $SERVICE_ACCOUNT_JSON > /tmp/service-account.json
          
          # Run the Expresso booking data download script
          - python main.py
          
          # Wait for 5 minutes
          - echo "Waiting for 5 minutes before processing data..."
          - sleep 300
          
          # Run the data processing script
          - export SERVICE_ACCOUNT_FILE=/tmp/service-account.json
          - export DOWNLOAD_DIR=/tmp/BookingData_folder
          - python dailyInnov_V2.py /tmp/BookingData_folder/BookingData.xlsx
        artifacts:
          - /tmp/BookingData_folder/**
        environment:
          EXPRESSO_USERNAME: ${EXPRESSO_USERNAME}
          EXPRESSO_PASSWORD: ${EXPRESSO_PASSWORD}
          GOOGLE_SHEET_URL: ${GOOGLE_SHEET_URL}