image: python:3.9

definitions:
  services:
    docker:
      memory: 2048

pipelines:
  default:
    - step:
        name: Download and Process Booking Data
        services:
          - docker
        script:
          # Install Chrome and dependencies
          - apt-get update && apt-get install -y wget gnupg2 curl
          - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
          - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list
          - apt-get update && apt-get install -y google-chrome-stable
          
          # Install Python dependencies
          - pip install -r requirements.txt
          
          # Create necessary directories
          - mkdir -p /tmp/BookingData_folder
          
          # Run the Expresso booking data download script
          - python main.py
          
          # Wait for 10 seconds
          - echo "Waiting for 10 seconds before processing data..."
          - sleep 10
          
          # Decode base64 service account JSON and save to file
          - echo "Decoding and saving service account JSON..."
          - echo $SERVICE_ACCOUNT_JSON | base64 -d > /tmp/service-account.json
          
          # Debug: Verify file exists and check its contents
          - echo "Verifying service account file..."
          - ls -l /tmp/service-account.json
          - echo "First few characters of service account file:"
          - head -c 50 /tmp/service-account.json
          
          # Run the data processing script with environment variables
          - export DOWNLOAD_DIR=/tmp/BookingData_folder
          - python dailyInnov_V2.py /tmp/BookingData_folder/BookingData.xlsx
          
          # Send email notification using SMTP
          - python send_email.py
          
        artifacts:
          - /tmp/BookingData_folder/**
        environment:
          EXPRESSO_USERNAME: ${EXPRESSO_USERNAME}
          EXPRESSO_PASSWORD: ${EXPRESSO_PASSWORD}
          GOOGLE_SHEET_URL: ${GOOGLE_SHEET_URL}
          SERVICE_ACCOUNT_JSON: ${SERVICE_ACCOUNT_JSON}
          SMTP_SERVER: ${SMTP_SERVER}
          SMTP_PORT: ${SMTP_PORT}
          SMTP_USERNAME: ${SMTP_USERNAME}
          SMTP_PASSWORD: ${SMTP_PASSWORD}

  schedules:
    - cron: '0 6 * * 1-5'  # 11:30 AM IST (6:00 UTC) Monday-Friday
      branches:
        include:
          - main  # or your default branch name
      name: Morning Data Update
      definition: default

    - cron: '0 11 * * 1-5'  # 4:30 PM IST (11:00 UTC) Monday-Friday
      branches:
        include:
          - main  # or your default branch name
      name: Evening Data Update
      definition: default 